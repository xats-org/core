# xats v0.4.0 Migration Guide

## Overview

Version 0.4.0 represents a major architectural change for the xats project, transitioning from a single-package structure to a modern monorepo architecture. This guide will help you migrate from v0.3.0 to v0.4.0.

## Breaking Changes

### Package Structure

The xats project is now organized as a monorepo with multiple packages:

```
@xats-org/schema       - Core JSON Schema definitions
@xats-org/validator    - Validation logic and error reporting
@xats-org/types        - Shared TypeScript types
@xats-org/cli          - Command-line interface
@xats-org/renderer     - Rendering framework (HTML, Markdown, Text)
@xats-org/utils        - Shared utilities
@xats-org/examples     - Example documents
@xats-org/vocabularies - Vocabulary definitions (NEW)
@xats-org/extensions   - Extension schemas (NEW)
@xats-org/mcp-server   - Model Context Protocol server (coming soon)
```

### Installation Changes

#### Before (v0.3.0)
```bash
npm install xats-validator
```

#### After (v0.4.0)
```bash
# Install specific packages as needed
npm install @xats-org/cli           # For CLI tools
npm install @xats-org/validator     # For validation
npm install @xats-org/renderer      # For rendering
npm install @xats-org/types         # For TypeScript types

# Or install all core packages
npm install @xats-org/cli @xats-org/validator @xats-org/renderer @xats-org/types
```

### Import Changes

#### TypeScript/JavaScript Imports

**Before (v0.3.0):**
```typescript
import { validate } from 'xats-validator';
import { XatsDocument } from 'xats-validator/types';
```

**After (v0.4.0):**
```typescript
import { validate } from '@xats-org/validator';
import { XatsDocument } from '@xats-org/types';
```

### CLI Changes

#### Command Names

**Before (v0.3.0):**
```bash
xats-validate document.json
```

**After (v0.4.0):**
```bash
xats validate document.json
xats render document.json --format html
xats stats document.json
xats format document.json
```

### API Changes

#### Validation API

**Before (v0.3.0):**
```typescript
const validator = new XatsValidator();
const result = validator.validate(document);
```

**After (v0.4.0):**
```typescript
import { createValidator } from '@xats-org/validator';

const validator = createValidator();
const result = await validator.validate(document);
```

#### Rendering API

**New in v0.4.0:**
```typescript
import { HTMLRenderer, MarkdownRenderer, TextRenderer } from '@xats-org/renderer';

const htmlRenderer = new HTMLRenderer();
const html = await htmlRenderer.render(document);

const mdRenderer = new MarkdownRenderer();
const markdown = await mdRenderer.render(document);
```

### Vocabulary URI Changes

**Important:** All vocabulary URIs have been updated to reflect the new package structure.

**Before (v0.3.0):**
```json
{
  "blockType": "https://xats.org/vocabularies/blocks/paragraph"
}
```

**After (v0.4.0):**
```json
{
  "blockType": "https://xats.org/vocabularies/blocks/paragraph"
}
```

## Migration Steps

### Step 1: Update Dependencies

1. Remove old packages:
```bash
npm uninstall xats-validator
```

2. Install new packages:
```bash
npm install @xats-org/cli @xats-org/validator @xats-org/renderer @xats-org/types
```

### Step 2: Update Imports

Search and replace all imports in your codebase:

```bash
# Find all old imports
grep -r "from 'xats-validator'" .
grep -r "require('xats-validator')" .

# Replace with new package names
# from 'xats-validator' → from '@xats-org/validator'
# from 'xats-validator/types' → from '@xats-org/types'
```

### Step 3: Update CLI Scripts

Update any scripts that use the CLI:

```json
{
  "scripts": {
    "validate": "xats validate src/**/*.json",
    "render": "xats render src/index.json --output dist/index.html"
  }
}
```

### Step 4: Update Document URIs

Run the migration script to update all vocabulary URIs in your documents:

```bash
npx @xats-org/cli migrate-uris ./path/to/documents
```

Or manually update URIs:
- `https://xats.org/vocabularies/blocks/*` → `https://xats.org/vocabularies/blocks/*`
- `https://xats.org/vocabularies/placeholders/*` → `https://xats.org/vocabularies/placeholders/*`
- `https://xats.org/vocabularies/hints/*` → `https://xats.org/vocabularies/hints/*`

### Step 5: Update TypeScript Types

If using TypeScript, update your type imports:

```typescript
// Before
import type { XatsDocument, ContentBlock } from 'xats-validator/types';

// After
import type { XatsDocument, ContentBlock } from '@xats-org/types';
```

### Step 6: Test Your Migration

1. Validate all documents:
```bash
xats validate **/*.json
```

2. Run your test suite:
```bash
npm test
```

3. Verify rendering output:
```bash
xats render test-document.json --format html --output test.html
```

## New Features in v0.4.0

### 1. Multiple Rendering Formats

The new `@xats-org/renderer` package supports multiple output formats:

```bash
xats render document.json --format html
xats render document.json --format markdown
xats render document.json --format text
```

### 2. Enhanced CLI

New CLI commands available:

```bash
xats validate   # Validate documents
xats render     # Render to various formats
xats stats      # Get document statistics
xats format     # Format JSON documents
xats info       # Get document information
```

### 3. Improved TypeScript Support

All packages now include comprehensive TypeScript definitions:

```typescript
import type {
  XatsDocument,
  ContentBlock,
  SemanticText,
  Chapter,
  Section,
  Unit
} from '@xats-org/types';
```

### 4. Modular Architecture

Install only what you need:

```bash
# Just validation
npm install @xats-org/validator @xats-org/types

# Just rendering
npm install @xats-org/renderer @xats-org/types

# Full suite
npm install @xats-org/cli
```

## Troubleshooting

### Issue: Module not found errors

**Solution:** Make sure you've installed all required packages:

```bash
npm install @xats-org/cli @xats-org/validator @xats-org/renderer @xats-org/types
```

### Issue: Invalid blockType URIs

**Solution:** Run the URI migration script:

```bash
npx @xats-org/cli migrate-uris ./documents
```

### Issue: TypeScript compilation errors

**Solution:** Update your `tsconfig.json` to include the new packages:

```json
{
  "compilerOptions": {
    "moduleResolution": "node",
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true
  }
}
```

### Issue: CLI command not found

**Solution:** Install the CLI globally or use npx:

```bash
# Global installation
npm install -g @xats-org/cli

# Or use npx
npx @xats-org/cli validate document.json
```

## Getting Help

- **GitHub Issues:** https://github.com/xats-org/core/issues
- **Documentation:** https://xats.org/docs
- **Discord:** https://discord.gg/xats

## Version Compatibility

| xats Version | Node.js | TypeScript |
|--------------|---------|------------|
| v0.3.0       | ≥16     | ≥4.5       |
| v0.4.0       | ≥18     | ≥5.0       |

## Next Steps

After migrating to v0.4.0:

1. Explore the new rendering capabilities
2. Try the enhanced CLI commands
3. Consider using the modular packages for better tree-shaking
4. Check out the new examples in `@xats-org/examples`

## Changelog

For a complete list of changes, see the [CHANGELOG](../CHANGELOG.md).